<h2 mat-dialog-title>{{ isEditMode ? 'Editar' : 'Nova' }} Avaliação</h2>

<mat-dialog-content class="form-content">
  <form [formGroup]="form">
    
    <div class="row-section">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Curso</mat-label>
        <mat-select formControlName="cursoId" (selectionChange)="aoSelecionarCurso($event.value)">
          <mat-option *ngIf="cursosDisponiveis.length === 0" disabled>Nenhum curso disponível</mat-option>
          <mat-option *ngFor="let curso of cursosDisponiveis" [value]="curso.id">
            <span class="curso-option-text">{{ curso.id }} - {{ curso.codigo || 'S/C' }} - {{ curso.titulo }}</span>
          </mat-option>
        </mat-select>
        <mat-error>Obrigatório</mat-error>
      </mat-form-field>
    </div>

    <div class="grid-2-custom">
      <mat-form-field appearance="outline" class="field-titulo">
        <mat-label>Título da Avaliação</mat-label>
        <input matInput formControlName="titulo">
      </mat-form-field>

      <div class="tipo-prova-box">
        <span class="label-tipo">Tipo:</span>
        <mat-radio-group formControlName="tipoAvaliacao" color="primary">
          <mat-radio-button value="OBJETIVA">Objetiva</mat-radio-button>
          <mat-radio-button value="DISCURSIVA">Discursiva</mat-radio-button>
        </mat-radio-group>
      </div>
    </div>

    <div class="grid-3">
      <mat-form-field appearance="outline">
        <mat-label>Tempo (min)</mat-label>
        <input matInput type="number" formControlName="tempoLimiteMinutos">
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Tentativas</mat-label>
        <input matInput type="number" formControlName="tentativasPermitidas">
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Nota Mínima (%)</mat-label>
        <input matInput type="number" formControlName="notaMinima">
        <span matSuffix>%</span>
      </mat-form-field>
    </div>

    <mat-divider class="my-3"></mat-divider>

    <div class="header-questoes">
      <h3>Questões ({{ form.get('tipoAvaliacao')?.value }})</h3>
      
      <button mat-raised-button color="primary" type="button" (click)="adicionarQuestao()">
        <mat-icon>add</mat-icon> Nova Questão
      </button>
    </div>

    <div formArrayName="questoes">
      <mat-accordion multi>
        <mat-expansion-panel *ngFor="let q of questoes.controls; let i = index" [formGroupName]="i" [expanded]="true">
          
          <mat-expansion-panel-header>
            <mat-panel-title><strong>Questão {{ i + 1 }}</strong></mat-panel-title>
            <mat-panel-description class="justify-end">
              <mat-icon color="warn" (click)="removerQuestao(i); $event.stopPropagation()" style="cursor: pointer;">delete</mat-icon>
            </mat-panel-description>
          </mat-expansion-panel-header>

          <div class="questao-row">
            <mat-form-field appearance="outline" class="field-peso">
              <mat-label>Peso</mat-label>
              <input matInput type="number" formControlName="peso">
            </mat-form-field>

            <mat-form-field appearance="outline" class="field-enunciado">
              <mat-label>Enunciado da Pergunta</mat-label>
              <textarea matInput formControlName="enunciado" rows="2"></textarea>
              <mat-error>Obrigatório</mat-error>
            </mat-form-field>
          </div>

          <div *ngIf="form.get('tipoAvaliacao')?.value === 'OBJETIVA'" class="alternativas-section">
            <p class="hint-text">Preencha as alternativas e <strong>clique na bolinha</strong> correspondente à resposta correta:</p>
            
            <mat-radio-group formControlName="respostaCorretaSelecionada">
              
              <div class="alternativa-row" *ngFor="let letra of ['A','B','C','D','E']">
                
                <mat-radio-button [value]="letra" color="primary" class="radio-correta" title="Marcar como correta">
                </mat-radio-button>

                <span class="letra-label">{{letra}})</span>

                <mat-form-field appearance="outline" class="full-width no-subscript">
                  <input matInput [formControlName]="'alternativa' + letra" [placeholder]="'Digite a resposta da alternativa ' + letra">
                </mat-form-field>

              </div>

            </mat-radio-group>
            
            <div class="error-msg" *ngIf="q.invalid && q.touched">
              <small>Preencha todas as alternativas e selecione a resposta correta.</small>
            </div>
          </div>

          <div *ngIf="form.get('tipoAvaliacao')?.value === 'DISCURSIVA'" class="discursiva-info">
            <mat-icon>info</mat-icon> <span>Questão dissertativa (o aluno digitará a resposta).</span>
          </div>

        </mat-expansion-panel>
      </mat-accordion>
    </div>

  </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button mat-dialog-close>Cancelar</button>
  <button mat-raised-button color="primary" (click)="onSubmit()">
    Salvar
  </button>
</mat-dialog-actions>