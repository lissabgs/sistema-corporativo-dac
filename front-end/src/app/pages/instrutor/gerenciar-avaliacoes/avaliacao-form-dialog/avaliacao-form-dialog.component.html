<div class="dialog-container">

  <div class="form-header">
    <h2>{{ isEditMode ? 'Editar Avaliação' : 'Nova Avaliação' }}</h2>
    <p>Defina as regras, o curso vinculado e as questões da prova.</p>
  </div>

  <mat-dialog-content class="custom-content">
    <form [formGroup]="form">
      
      <div class="section-title">Configurações da Prova</div>

      <div class="row-section">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Curso Vinculado</mat-label>
          <mat-select formControlName="cursoId" (selectionChange)="aoSelecionarCurso($event.value)">
            <mat-option *ngIf="cursosDisponiveis.length === 0" disabled>Nenhum curso disponível</mat-option>
            <mat-option *ngFor="let curso of cursosDisponiveis" [value]="curso.id">
              {{ curso.id }} - {{ curso.codigo || 'S/C' }} - {{ curso.titulo }}
            </mat-option>
          </mat-select>
          <mat-error>Obrigatório</mat-error>
        </mat-form-field>
      </div>

      <div class="grid-2-custom">
        <mat-form-field appearance="outline" class="field-titulo">
          <mat-label>Título da Avaliação</mat-label>
          <input matInput formControlName="titulo">
          <mat-error>Obrigatório</mat-error>
        </mat-form-field>

        <div class="tipo-prova-box">
          <span class="label-tipo">Modelo de Prova:</span>
          <mat-radio-group formControlName="tipoAvaliacao" color="primary">
            <mat-radio-button value="OBJETIVA">Objetiva</mat-radio-button>
            <mat-radio-button value="DISCURSIVA">Discursiva</mat-radio-button>
          </mat-radio-group>
        </div>
      </div>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Descrição / Instruções</mat-label>
        <textarea matInput formControlName="descricao" rows="2"></textarea>
      </mat-form-field>

      <div class="grid-3">
        <mat-form-field appearance="outline">
          <mat-label>Tempo Limite (min)</mat-label>
          <input matInput type="number" formControlName="tempoLimiteMinutos">
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Tentativas</mat-label>
          <input matInput type="number" formControlName="tentativasPermitidas">
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Nota Mínima (%)</mat-label>
          <input matInput type="number" formControlName="notaMinima">
          <span matSuffix>%</span>
        </mat-form-field>
      </div>

      <mat-divider class="my-4"></mat-divider>

      <div class="header-questoes-row">
        <div class="section-title no-margin">
          Questões ({{ form.get('tipoAvaliacao')?.value === 'OBJETIVA' ? 'Múltipla Escolha' : 'Dissertativa' }})
        </div>
        <button mat-raised-button color="primary" type="button" (click)="adicionarQuestao()">
          <mat-icon>add</mat-icon> Nova Questão
        </button>
      </div>

      <div formArrayName="questoes" class="questoes-list">
        
        <div *ngIf="questoes.controls.length === 0" class="empty-state">
          <mat-icon>quiz</mat-icon>
          <p>Nenhuma questão adicionada.</p>
        </div>

        <mat-accordion multi>
          <mat-expansion-panel *ngFor="let q of questoes.controls; let i = index" [formGroupName]="i" [expanded]="true" class="mb-2">
            
            <mat-expansion-panel-header>
              <mat-panel-title>
                <strong>Questão {{ i + 1 }}</strong>
              </mat-panel-title>
              <mat-panel-description class="justify-end">
                <mat-icon color="warn" (click)="removerQuestao(i); $event.stopPropagation()" class="clickable">delete</mat-icon>
              </mat-panel-description>
            </mat-expansion-panel-header>

            <div class="questao-content">
              
              <div class="questao-row">
                <mat-form-field appearance="outline" class="field-peso">
                  <mat-label>Peso</mat-label>
                  <input matInput type="number" formControlName="peso">
                </mat-form-field>

                <mat-form-field appearance="outline" class="field-enunciado">
                  <mat-label>Enunciado da Pergunta</mat-label>
                  <textarea matInput formControlName="enunciado" rows="2"></textarea>
                  <mat-error>Obrigatório</mat-error>
                </mat-form-field>
              </div>

              <div *ngIf="form.get('tipoAvaliacao')?.value === 'OBJETIVA'" class="alternativas-section">
                <p class="hint-text">Preencha as opções e <strong>marque a correta</strong>:</p>
                
                <mat-radio-group formControlName="respostaCorretaSelecionada">
                  <div class="alternativa-row" *ngFor="let letra of ['A','B','C','D','E']">
                    <mat-radio-button [value]="letra" color="primary" class="radio-correta"></mat-radio-button>
                    <span class="letra-label">{{letra}})</span>
                    <mat-form-field appearance="outline" class="full-width no-subscript dense-field">
                      <input matInput [formControlName]="'alternativa' + letra">
                    </mat-form-field>
                  </div>
                </mat-radio-group>
                
                <div class="error-msg" *ngIf="q.invalid && q.touched">
                  Preencha as alternativas e selecione a correta.
                </div>
              </div>

              <div *ngIf="form.get('tipoAvaliacao')?.value === 'DISCURSIVA'" class="discursiva-info">
                <mat-icon>info</mat-icon> 
                <span>Questão dissertativa: o aluno digitará a resposta e você fará a correção manual.</span>
              </div>

            </div>
          </mat-expansion-panel>
        </mat-accordion>
      </div>

    </form>
  </mat-dialog-content>

  <div class="dialog-actions">
    <button mat-button mat-dialog-close>Cancelar</button>
    <button mat-raised-button color="primary" (click)="onSubmit()" [disabled]="form.invalid">
      <mat-icon>save</mat-icon> Salvar Avaliação
    </button>
  </div>

</div>