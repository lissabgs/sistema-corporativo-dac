<div class="page-background">
  
  <div class="form-container mat-elevation-z8">
    
    <div class="form-header">
      <h2>{{ isEditMode ? 'Editar Curso' : 'Novo Curso' }}</h2>
      <p>Preencha os dados do curso e estruture os módulos abaixo.</p>
    </div>

    <form [formGroup]="cursoForm" (ngSubmit)="onSubmit()">
      
      <div class="section-title">Informações Básicas</div>
      
      <div class="grid-2">
        <mat-form-field appearance="outline">
          <mat-label>Código do Curso</mat-label>
          <input matInput 
                 formControlName="codigo" 
                 placeholder="EX: JAVA-BASIC"
                 (input)="formatarCodigo($event)"
                 maxlength="20">
          <mat-error *ngIf="cursoForm.get('codigo')?.hasError('pattern')">Formato inválido (ABC-123)</mat-error>
          <mat-error *ngIf="cursoForm.get('codigo')?.hasError('required')">Obrigatório</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Título do Curso</mat-label>
          <input matInput formControlName="titulo">
          <mat-error *ngIf="cursoForm.get('titulo')?.hasError('required')">Obrigatório</mat-error>
        </mat-form-field>
      </div>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Descrição</mat-label>
        <textarea matInput formControlName="descricao" rows="3"></textarea>
      </mat-form-field>

      <div class="grid-3">
        <mat-form-field appearance="outline">
          <mat-label>Departamento</mat-label>
          <mat-select formControlName="categoriaId">
             <mat-option *ngFor="let dept of departamentos" [value]="dept.nome">
               {{ dept.nome }}
             </mat-option>
          </mat-select>
          <mat-error>Obrigatório</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Duração (h)</mat-label>
          <input matInput type="number" formControlName="duracaoEstimada">
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>XP Total</mat-label>
          <input matInput 
                 type="number" 
                 formControlName="xpOferecido"
                 (focus)="limparSeZero('xpOferecido')" 
                 (blur)="restaurarSeVazio('xpOferecido')">
        </mat-form-field>
      </div>

      <div class="grid-2">
        <mat-form-field appearance="outline">
          <mat-label>Nível</mat-label>
          <mat-select formControlName="nivelDificuldade">
            <mat-option value="Iniciante">Iniciante</mat-option>
            <mat-option value="Intermediário">Intermediário</mat-option>
            <mat-option value="Avançado">Avançado</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Status</mat-label>
          <mat-select formControlName="status">
            <mat-option value="RASCUNHO">Rascunho</mat-option>
            <mat-option value="ATIVO">Ativo</mat-option>
            <mat-option value="INATIVO">Inativo</mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <mat-divider class="my-3"></mat-divider>

      <div class="modules-header">
        <div class="section-title">Módulos e Aulas</div>
        <button mat-raised-button color="primary" type="button" (click)="adicionarModulo()">
          <mat-icon>library_add</mat-icon> Adicionar Módulo
        </button>
      </div>

      <div formArrayName="modulos" class="modules-list">
        
        <div *ngIf="modulos.controls.length === 0" class="empty-state">
          <mat-icon>playlist_add</mat-icon>
          <p>Nenhum módulo cadastrado. Clique em "Adicionar Módulo" para começar.</p>
        </div>

        <mat-accordion multi>
          <mat-expansion-panel *ngFor="let mod of modulos.controls; let i = index" [formGroupName]="i" [expanded]="true">
            
            <mat-expansion-panel-header>
              <mat-panel-title>
                <strong>{{ i + 1 }}. {{ mod.get('titulo')?.value || 'Novo Módulo' }}</strong>
              </mat-panel-title>
              <mat-panel-description class="justify-end">
                <button mat-icon-button color="warn" (click)="removerModulo(i); $event.stopPropagation()" title="Excluir Módulo">
                  <mat-icon>delete_forever</mat-icon>
                </button>
              </mat-panel-description>
            </mat-expansion-panel-header>

            <div class="module-content">
              
              <div class="grid-module-config">
                <mat-form-field appearance="outline" class="field-titulo-mod">
                  <mat-label>Título do Módulo</mat-label>
                  <input matInput formControlName="titulo">
                </mat-form-field>
                
                <mat-form-field appearance="outline" class="field-ordem-mod">
                  <mat-label>Ordem</mat-label>
                  <input matInput type="number" formControlName="ordem">
                </mat-form-field>

                <div class="checkbox-box">
                  <mat-checkbox formControlName="obrigatorio" color="primary">
                    Módulo Obrigatório
                  </mat-checkbox>
                </div>
              </div>

              <div class="lessons-container">
                <div class="lessons-header">
                  <h4>Aulas</h4>
                  <button mat-stroked-button color="primary" type="button" (click)="adicionarAula(i)">
                    <mat-icon>add</mat-icon> Nova Aula
                  </button>
                </div>

                <div formArrayName="aulas">
                  <table class="lessons-table" *ngIf="aulas(i).controls.length > 0">
                    <thead>
                      <tr>
                        <th width="5%">#</th>
                        <th width="50%">Título da Aula</th> <th width="40%">Link / URL do Conteúdo</th> <th width="5%"></th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let aula of aulas(i).controls; let j = index" [formGroupName]="j">
                        <td class="text-center">{{ j + 1 }}</td>
                        <td>
                          <input type="text" class="clean-input" formControlName="titulo" placeholder="Ex: Introdução ao Java">
                        </td>
                        <td>
                          <input type="text" class="clean-input" formControlName="urlConteudo" placeholder="https://...">
                        </td>
                        <td class="text-center">
                          <mat-icon class="delete-icon" (click)="removerAula(i, j)">close</mat-icon>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                  
                  <div *ngIf="aulas(i).controls.length === 0" class="empty-lessons">
                    Nenhuma aula neste módulo.
                  </div>
                </div>
              </div>
            </div>

          </mat-expansion-panel>
        </mat-accordion>
      </div>

      <div class="form-actions">
        <button mat-button type="button" (click)="voltar()">Cancelar</button>
        <button mat-raised-button color="primary" class="btn-save" [disabled]="cursoForm.invalid">
          <mat-icon>save</mat-icon> Salvar Curso Completo
        </button>
      </div>

    </form>
  </div>
</div>